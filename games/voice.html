<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</title>
    <!-- Tone.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #222;
            color: #fff;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { margin-bottom: 10px; }
        .warning {
            color: #ff4444;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: bold;
            color: #d8000c;
        }
        .controls { margin-bottom: 30px; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #btn-start { background-color: #28a745; color: white; }
        #btn-stop { background-color: #dc3545; color: white; display: none; }
        
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }
        
        .voice-btn {
            background-color: #444;
            color: white;
            padding: 15px;
            border: 2px solid transparent;
        }
        .voice-btn:hover { background-color: #555; }
        .voice-btn.active {
            border-color: #007bff;
            background-color: #0056b3;
            box-shadow: 0 0 10px #007bff;
        }

        #visualizer {
            width: 100%;
            max-width: 600px;
            height: 60px;
            background: #000;
            margin-top: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</h1>
    <div class="warning">
        âš  ãƒã‚¦ãƒªãƒ³ã‚°é˜²æ­¢ã®ãŸã‚ã€å¿…ãšãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³/ã‚¤ãƒ¤ãƒ›ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="controls">
        <button id="btn-start">ãƒã‚¤ã‚¯ã‚’ã‚ªãƒ³ã«ã™ã‚‹</button>
        <button id="btn-stop">åœæ­¢</button>
    </div>

    <div class="voice-grid" id="voice-selector">
        <button class="voice-btn active" data-type="normal">ãƒãƒ¼ãƒãƒ«</button>
        <button class="voice-btn" data-type="chipmunk">ãƒªã‚¹ï¼ˆé«˜éŸ³ï¼‰</button>
        <button class="voice-btn" data-type="monster">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼ˆä½éŸ³ï¼‰</button>
        <button class="voice-btn" data-type="robot">ãƒ­ãƒœãƒƒãƒˆ</button>
        <button class="voice-btn" data-type="vibrato">å®‡å®™äºº</button>
        <button class="voice-btn" data-type="echo">æ´çªŸï¼ˆã‚¨ã‚³ãƒ¼ï¼‰</button>
        <button class="voice-btn" data-type="radio">ç„¡ç·šæ©Ÿ</button>
    </div>

    <canvas id="visualizer"></canvas>

    <script>
        // å¤‰æ•°ã®åˆæœŸåŒ–
        let mic;
        let activeEffect = null;
        let currentVoice = 'normal';
        let isRunning = false;
        let analyser;
        
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const voiceBtns = document.querySelectorAll('.voice-btn');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // ãƒã‚¤ã‚¯é–‹å§‹å‡¦ç†
        btnStart.addEventListener('click', async () => {
            try {
                // AudioContextã®é–‹å§‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒªã‚·ãƒ¼å¯¾å¿œï¼‰
                await Tone.start();
                
                // ãƒã‚¤ã‚¯å…¥åŠ›ã®ä½œæˆ
                mic = new Tone.UserMedia();
                
                // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨
                analyser = new Tone.Analyser("waveform", 256);

                await mic.open();
                
                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®é©ç”¨
                applyEffect(currentVoice);

                // UIæ›´æ–°
                isRunning = true;
                btnStart.style.display = 'none';
                btnStop.style.display = 'inline-block';
                drawVisualizer();
                
            } catch (err) {
                console.error(err);
                alert("ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        });

        // ãƒã‚¤ã‚¯åœæ­¢å‡¦ç†
        btnStop.addEventListener('click', () => {
            if (mic) {
                mic.close();
                mic.dispose(); // ãƒ¡ãƒ¢ãƒªè§£æ”¾
            }
            if (activeEffect) {
                activeEffect.dispose();
                activeEffect = null;
            }
            isRunning = false;
            btnStart.style.display = 'inline-block';
            btnStop.style.display = 'none';
            // ç”»é¢ã‚¯ãƒªã‚¢
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // ãƒœã‚¤ã‚¹é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç†
        voiceBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // UIã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
                voiceBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                currentVoice = btn.getAttribute('data-type');
                
                if (isRunning) {
                    applyEffect(currentVoice);
                }
            });
        });

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applyEffect(type) {
            // æ—¢å­˜ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒã‚ã‚Œã°ç ´æ£„
            if (activeEffect) {
                mic.disconnect();
                activeEffect.dispose();
                activeEffect = null;
            }

            // ãƒã‚¤ã‚¯å…¥åŠ›ã‚’è§£ææ©Ÿã«ã¤ãªãï¼ˆå¸¸ã«æ³¢å½¢ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
            mic.connect(analyser);

            switch (type) {
                case 'normal':
                    // ãã®ã¾ã¾å‡ºåŠ›
                    mic.toDestination();
                    break;

                case 'chipmunk':
                    // ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆï¼ˆ+6ã‚»ãƒŸãƒˆãƒ¼ãƒ³ï¼‰
                    activeEffect = new Tone.PitchShift(6).toDestination();
                    mic.connect(activeEffect);
                    break;

                case 'monster':
                    // ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆï¼ˆ-6ã‚»ãƒŸãƒˆãƒ¼ãƒ³ï¼‰
                    activeEffect = new Tone.PitchShift(-6).toDestination();
                    mic.connect(activeEffect);
                    break;

                case 'robot':
                    // ãƒªãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé‡‘å±çš„ãªéŸ³ï¼‰
                    // distortion: æ­ªã¿, frequency: å‘¨æ³¢æ•°
                    activeEffect = new Tone.Chebyshev(50).toDestination();
                    const ringMod = new Tone.FrequencyShifter(100).connect(activeEffect);
                    mic.connect(ringMod);
                    // è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã‚’ä½¿ã†ãŸã‚activeEffectã‚’é…åˆ—ã‹ã‚°ãƒ«ãƒ¼ãƒ—ã§ç®¡ç†ã™ã¹ãã ãŒç°¡æ˜“çš„ã«å‡¦ç†
                    activeEffect = ringMod; 
                    break;

                case 'vibrato':
                    // ãƒˆãƒ¬ãƒ¢ãƒ­ï¼ˆéŸ³ãŒæºã‚Œã‚‹ï¼‰
                    activeEffect = new Tone.Vibrato(10, 0.5).toDestination();
                    mic.connect(activeEffect);
                    break;

                case 'echo':
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ã‚£ãƒ¬ã‚¤
                    activeEffect = new Tone.FeedbackDelay("8n", 0.5).toDestination();
                    mic.connect(activeEffect);
                    break;
                
                case 'radio':
                    // ãƒ“ãƒƒãƒˆã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼ï¼ˆè§£åƒåº¦ã‚’ä¸‹ã’ã¦ãƒã‚¤ã‚ºã£ã½ãï¼‰+ EQ
                    const bitCrusher = new Tone.BitCrusher(4);
                    const eq = new Tone.EQ3({ high: -10, mid: 0, low: -20 });
                    bitCrusher.connect(eq);
                    eq.toDestination();
                    mic.connect(bitCrusher);
                    activeEffect = bitCrusher; // ç°¡æ˜“ç®¡ç†
                    break;
            }
        }

        // æ³¢å½¢æç”»ãƒ«ãƒ¼ãƒ—
        function drawVisualizer() {
            if (!isRunning) return;

            requestAnimationFrame(drawVisualizer);

            const buffer = analyser.getValue();
            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#00ff00';
            canvasCtx.beginPath();

            const sliceWidth = canvas.width / buffer.length;
            let x = 0;

            for (let i = 0; i < buffer.length; i++) {
                const v = buffer[i] * 0.5 + 0.5; // æ­£è¦åŒ–
                const y = v * canvas.height;

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }
    </script>
</body>
</html>